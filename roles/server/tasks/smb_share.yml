---

# Create the inbox directory
- name: samba share | create inbox dir
  file:
    path: /inbox
    mode: '0777'
    state: directory
  become: yes

#confirm if smb_credential file is present
- name: samba share | confirm credential file present
  stat:
    path: /etc/.smb_cred
  register: smbc_exists

#if not present then ask for credentials

- name: samba share | pause for credentials
  pause:
    seconds: 2
  no_log: true
  when: smbc_exists.stat.exists == False

- name: samba share | no credential ask for info user
  pause:
    prompt: 'Server profile started - Variables for playbook - Samba Share server?'
  register: prompt_srv
  no_log: true
  when: smbc_exists.stat.exists == False

- name: samba share | no credential ask for info user
  pause:
    prompt: 'Server profile started - Variables for playbook - Samba Share user?'
  register: prompt_usr
  no_log: true
  when: smbc_exists.stat.exists == False

- name: samba share | no credential ask for info pwd
  pause:
    prompt: 'Server profile started - Variables for playbook - Samba Share pwd?'
    echo: no
  register: prompt_pwd
  no_log: true
  when: smbc_exists.stat.exists == False

#Create credential file
- name: samba share | create .smb_credentials file
  file:
    path: /etc/.smb_cred
    owner: root
    group: root
    mode: '0600'
    state: touch
  when: smbc_exists.stat.exists == False

#Add credentials in file
- name: samba share | add username and password to credential file
  blockinfile:
    backup: yes
    path: /etc/.smb_cred
    state: present
    marker: ""
    block: |
      username={{ prompt_usr.user_input }}
      password={{ prompt_pwd.user_input }}
  become: yes
  when: smbc_exists.stat.exists == False

# remove markets
- name: samba share | remove markers
  lineinfile:
    path: /etc/.smb_cred
    state: absent
    regexp: '^$'

 # Add line in fstab, _netdev,nofail,vers=3.0,
- name: samba share | add share to fstab
  lineinfile:
    backup: yes
    path: /etc/fstab
    line: '//{{ prompt_srv.user_input }}/inbox /inbox cifs x-systemd.mount-timeout=30,x-systemd.automount,_netdev,credentials=/etc/.smb_cred,iocharset=utf8,noperm 0 0'
    state: present
  become: yes
  register: fstab
  when: smbc_exists.stat.exists == False

 # Mount inbox shared filesystem

- name: samba share | mount if changed
  command: 'mount /inbox'
  become: yes
  when: fstab.changed
